#!/usr/bin/env zsh

COMPOSE_OUTPUT=$(docker compose ls --format json | jq ".[] | {name: .Name, config: .ConfigFiles}" --compact-output)
CMDS=$(echo "ps down up" | tr ' ' '\n')
COMPOSE_TARGETS=$(echo $COMPOSE_OUTPUT | jq .name | tr -d \")

SELECTED=$(printf "$COMPOSE_TARGETS\n" | fzf)
SELECTED_CONFIG=$(echo $COMPOSE_OUTPUT | jq ". | select( .name | contains(\"$SELECTED\") ) | .config " | tr -d \")
DIR=$(dirname $SELECTED_CONFIG)

CMD=$(printf "$CMDS\n" | fzf)

tmux new-window -c $DIR "docker compose $CMD & while [ : ]; do sleep 1; done"
